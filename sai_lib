#!/bin/bash

say() {
	tput setaf 4
	echo ":: $1"
	tput sgr0
}

ask() {
	tput setaf 6
	echo -n "=> $1  "
	tput sgr0
	read ans
}

yell() {
	tput setaf 1
	echo -n "!! $1  "
	tput sgr0
	echo "$1" >> $LOG
}

format_disks() {
	local part=$1
	local fstype=$2
	case $fstype in
		swap)
			swapoff $part
			mkswap $part
			swapon $part
			;;
		ext2)
			mke2fs $part
			;;
		ext3)
			mke2fs -j $part
			;;
		ext4)
			mke2fs -t ext4 $part
			;;
	esac
	sleep 1
}

prepare_disks() {
	for line in $(cat $FS); do
		part=$(echo $line | cut -d : -f 1)
		mp=$(echo $line | cut -d : -f 2)
		fstype=$(echo $line | cut -d : -f 3)

		format_disks $part $fstype
		
		mkdir -p /mnt$mp
		mount -t $fstype $part /mnt$mp
		
		echo -n "$part $mp $fstype defaults 0 " >> $FSTAB
		if [ "$fstype" = "swap" ]; then
			echo "0" >> $FSTAB
		else
			echo "1" >> $FSTAB
		fi
	done
}

find_disks() {
	workdir="$PWD"
	cd /sys/block
	ls | grep '^[hs]d'
	cd "$workdir"
}

find_partitions() {
	workdir="$PWD"
	for disk in $(find_disks); do
		cd /sys/block/$disk
		for part in $disk*; do
			echo "$part"
		done
	done
	cd "$workdir"
}

disk_capacity() {
	fdisk -l $1 | sed -n '2p' | cut -d ' ' -f 3,4 | sed 's|,$||'
}

avail_disks() {
	for disk in $(find_disks); do
		echo "$disk: $(disk_capacity /dev/$disk)"
	done
}

# chroot_mount()
# prepares target system as a chroot
#
chroot_mount() {
	[ -e /mnt/sys ] || mkdir /mnt/sys
	[ -e /mnt/proc ] || mkdir /mnt/proc
	[ -e /mnt/dev ] || mkdir /mnt/dev
	mount -t sysfs sysfs /mnt/sys
	mount -t proc proc /mnt/proc
	mount -o bind /dev /mnt/dev
}

# chroot_umount()
# tears down chroot in target system
#
chroot_umount() {
	umount /mnt/proc /mnt/sys /mnt/dev
}

search_device() {
	grep ":$1:" $FS | cut -d : -f 1
}

generate_syslinux_menu() {
	sed -i -e '/#-\*/q' "$syslinuxmenu"
	
	cat >> $syslinuxmenu <<EOF

# (0) Arch Linux
LABEL arch
    MENU LABEL Arch Linux
    LINUX ../vmlinuz-linux
    APPEND root=$1 ro
    INITRD ../initramfs-linux.img

# (1) Arch Linux Fallback
LABEL archfallback
    MENU LABEL Arch Linux Fallback
    LINUX ../vmlinuz-linux
    APPEND root=$1 ro
    INITRD ../initramfs-linux-fallback.img

# (2) Windows
#LABEL windows
#COM32 chain.c32
#APPEND hd0 0

LABEL hdt
    MENU LABEL HDT (Hardware Detection Tool)
    COM32 hdt.c32

LABEL reboot
    MENU LABEL Reboot
    COM32 reboot.c32

LABEL off
    MENU LABEL Power Off
    COMBOOT poweroff.com
EOF
}
